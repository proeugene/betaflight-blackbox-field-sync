<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Betaflight Blackbox Syncer</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0; padding: 0;
      background: #0f0f12;
      color: #e0e0e8;
      min-height: 100vh;
    }
    header {
      background: #1a1a24;
      border-bottom: 1px solid #2e2e40;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky; top: 0; z-index: 100;
    }
    header h1 { margin: 0; font-size: 1.1rem; font-weight: 600; }
    #status-badge {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 12px;
      background: #2e2e40;
      color: #a0a0b8;
    }
    #status-badge.syncing  { background: #1a3a5c; color: #60b0ff; }
    #status-badge.erasing  { background: #3a2a10; color: #ffaa40; }
    #status-badge.verifying { background: #2a1a4a; color: #c060ff; }
    #status-badge.error    { background: #3a1a1a; color: #ff6060; }
    main { max-width: 700px; margin: 0 auto; padding: 16px; }
    .disk-info {
      background: #1a1a24;
      border: 1px solid #2e2e40;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 16px;
      font-size: 0.85rem;
      color: #a0a0b8;
    }
    .disk-bar-track {
      background: #2e2e40;
      border-radius: 4px;
      height: 6px;
      margin-top: 6px;
      overflow: hidden;
    }
    .disk-bar-fill {
      background: #4060d0;
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s;
    }
    .fc-group { margin-bottom: 20px; }
    .fc-group summary {
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      color: #c0c0d8;
      padding: 8px 0;
      list-style: none;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid #2e2e40;
      user-select: none;
    }
    .fc-group summary::before { content: "â–¶"; font-size: 0.7rem; transition: transform 0.2s; }
    .fc-group[open] summary::before { transform: rotate(90deg); }
    .session-card {
      background: #1a1a24;
      border: 1px solid #2e2e40;
      border-radius: 8px;
      padding: 12px 14px;
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .session-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }
    .session-title { font-size: 0.9rem; font-weight: 500; }
    .session-meta { font-size: 0.75rem; color: #808098; display: flex; gap: 10px; flex-wrap: wrap; }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 8px;
      font-size: 0.7rem;
      background: #2e2e40;
      color: #909098;
    }
    .badge.erased { background: #1a3a1a; color: #60d060; }
    .badge.no-erase { background: #3a2a10; color: #c08030; }
    .session-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    button, a.btn {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      border: none;
      text-decoration: none;
      font-weight: 500;
      transition: opacity 0.15s;
    }
    button:hover, a.btn:hover { opacity: 0.8; }
    .btn-download { background: #2a4a80; color: #a0c8ff; }
    .btn-manifest { background: #2e2e40; color: #a0a0b8; }
    .btn-delete   { background: #4a1a1a; color: #ff8080; }
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: #505068;
    }
    .empty-state .icon { font-size: 3rem; margin-bottom: 12px; }
    .progress-bar-track {
      background: #2e2e40;
      border-radius: 3px;
      height: 4px;
      overflow: hidden;
      display: none;
    }
    .progress-bar-fill {
      background: #60b0ff;
      height: 100%;
      width: 0%;
      border-radius: 3px;
      transition: width 0.5s;
    }
  </style>
</head>
<body>

<header>
  <h1>Betaflight Blackbox Syncer</h1>
  <span id="status-badge">Idle</span>
</header>

<div id="sync-progress-container" style="background:#1a2a3a; padding:0 20px; display:none;">
  <div style="max-width:700px; margin:0 auto; padding:8px 0; font-size:0.8rem; color:#60b0ff;">
    <span id="sync-progress-label">Syncing...</span>
    <div class="progress-bar-track" id="progress-track" style="display:block; margin-top:4px;">
      <div class="progress-bar-fill" id="progress-fill"></div>
    </div>
  </div>
</div>

<main>
  <div class="disk-info">
    {% set total_gb = used_gb + free_gb %}
    {% set pct = ((used_gb / total_gb * 100) | int) if total_gb > 0 else 0 %}
    <span>Pi SD card: <strong>{{ "%.1f"|format(used_gb) }} GB used</strong> / {{ "%.1f"|format(free_gb) }} GB free</span>
    <div class="disk-bar-track">
      <div class="disk-bar-fill" style="width: {{ pct }}%"></div>
    </div>
  </div>

  {% if sessions %}
    {% set ns = namespace(current_fc=None) %}
    {% for session in sessions %}
      {% set fc_dir = session.fc_dir %}
      {% if fc_dir != ns.current_fc %}
        {% if ns.current_fc is not none %}</div></details>{% endif %}
        {% set ns.current_fc = fc_dir %}
        <details class="fc-group" open>
        <summary>{{ fc_dir }}</summary>
        <div>
      {% endif %}

      {% set m = session.manifest %}
      {% set fc_ver = m.fc.api_version if m and m.fc else "?" %}
      {% set file_size = m.file.bytes if m and m.file else 0 %}
      {% set file_mb = (file_size / 1048576) | round(1) %}
      {% set erased = m.erase_completed if m else false %}

      <div class="session-card">
        <div class="session-header">
          <span class="session-title">{{ session.session_dir | replace('_', ' ') }}</span>
          <span class="badge {{ 'erased' if erased else 'no-erase' }}">
            {{ "Erased" if erased else "Not erased" }}
          </span>
        </div>
        <div class="session-meta">
          <span>{{ file_mb }} MB</span>
          <span>API {{ fc_ver }}</span>
          {% if m and m.file and m.file.sha256 %}
          <span title="{{ m.file.sha256 }}">SHA-256: {{ m.file.sha256[:12] }}â€¦</span>
          {% endif %}
        </div>
        <div class="session-actions">
          {% if session.bbl_path %}
          <a class="btn btn-download" href="/download/{{ session.session_id }}/raw_flash.bbl">
            Download .bbl
          </a>
          {% endif %}
          <a class="btn btn-manifest" href="/download/{{ session.session_id }}/manifest.json">
            Manifest
          </a>
          <button class="btn-delete"
                  onclick="deleteSession('{{ session.session_id }}', this)">
            Delete from Pi
          </button>
        </div>
      </div>

      {% if loop.last %}</div></details>{% endif %}
    {% endfor %}
  {% else %}
    <div class="empty-state">
      <div class="icon">ðŸ“­</div>
      <p>No sessions yet.<br>Plug in a Betaflight FC to start syncing.</p>
    </div>
  {% endif %}
</main>

<script>
  // Poll sync status every 3 seconds
  function updateStatus() {
    fetch('/status')
      .then(r => r.json())
      .then(data => {
        const badge = document.getElementById('status-badge');
        const state = data.state || 'idle';
        const progress = data.progress || 0;
        const labels = {
          idle: 'Idle', identifying: 'Identifying FCâ€¦',
          querying: 'Querying flashâ€¦', syncing: 'Syncingâ€¦',
          verifying: 'Verifyingâ€¦', erasing: 'Erasingâ€¦', error: 'Error'
        };
        badge.textContent = (labels[state] || state) +
          (state === 'syncing' && progress > 0 ? ` ${progress}%` : '');
        badge.className = '';
        if (['syncing','identifying','querying'].includes(state)) badge.classList.add('syncing');
        else if (state === 'erasing') badge.classList.add('erasing');
        else if (state === 'verifying') badge.classList.add('verifying');
        else if (state === 'error') badge.classList.add('error');

        const progressContainer = document.getElementById('sync-progress-container');
        const progressFill = document.getElementById('progress-fill');
        const progressLabel = document.getElementById('sync-progress-label');
        if (state === 'syncing') {
          progressContainer.style.display = 'block';
          progressFill.style.width = progress + '%';
          progressLabel.textContent = `Syncing flash... ${progress}%`;
        } else {
          progressContainer.style.display = 'none';
        }
      })
      .catch(() => {});
  }
  updateStatus();
  setInterval(updateStatus, 3000);

  // Delete session
  function deleteSession(sessionId, btn) {
    if (!confirm('Delete this session from the Pi?\n\nMake sure you have downloaded the .bbl file first.')) return;
    btn.disabled = true;
    btn.textContent = 'Deletingâ€¦';
    fetch('/sessions/' + sessionId, { method: 'DELETE' })
      .then(r => r.json())
      .then(data => {
        if (data.deleted) {
          const card = btn.closest('.session-card');
          card.style.transition = 'opacity 0.3s';
          card.style.opacity = '0';
          setTimeout(() => { card.remove(); location.reload(); }, 300);
        } else {
          btn.disabled = false;
          btn.textContent = 'Delete from Pi';
          alert('Delete failed.');
        }
      })
      .catch(() => {
        btn.disabled = false;
        btn.textContent = 'Delete from Pi';
        alert('Delete request failed.');
      });
  }
</script>
</body>
</html>
